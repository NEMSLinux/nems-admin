#!/bin/bash
echo $0 > /var/www/html/userfiles/nems-build.cur

# Get the platform before removing php (as it requires PHP)
platform=$(/usr/local/bin/nems-info platform)

# Install and configure check-mk-livestatus

# Need to do an update because a lot of time has passed by now
apt-get update
apt-get install -y php-net-socket
apt-get install -y sqlite3
apt-get install -y graphviz
apt-get install -y rrdtool
apt-get install -y librrd-dev
apt-get install -y libboost-all-dev
apt-get install -y libncurses5-dev
apt-get install -y libreadline-dev
apt-get install -y libxml2-dev
apt-get install -y libssl-dev
apt-get install -y clang
apt-get install -y chrpath
apt-get install -y libkrb5-dev
apt-get install -y librust-pangocairo-dev
apt-get install -y libperl-dev
apt-get install -y apache2-dev
apt-get install -y virtualenv
apt-get install -y freetds-dev # pymssql
apt-get install -y python-setuptools
apt-get install -y libsasl2-dev
apt-get install -y libxslt1-dev

pip install wheel
pip install pipenv

tmpdir=`mktemp -d -p /tmp/`

# Packages are located on repos server
# To create this tarball, see 055-check_mk-create
ver="2.1.0p9"
wget -O ${tmpdir}/mk.tar.gz https://packages.nemslinux.com/livestatus/checkmk-livestatus-{$ver}.tar.gz
cd $tmpdir
tar xzf mk.tar.gz
cd checkmk-livestatus

# Install livestatus
# Need to determine the lib directory for boost to compile correctly
# Try to do it automatically by the fact that the directory exists
if [[ -d /usr/lib/arm-linux-gnueabihf ]]; then
  # Raspberry Pi / ARM
  libdir=/usr/lib/arm-linux-gnueabihf
elif [[ -d /usr/lib/i386-linux-gnu ]]; then
  # 32-Bit
  libdir=/usr/lib/i386-linux-gnu
elif [[ -d /usr/lib/x86_64-linux-gnu ]]; then
  # 64-Bit
  libdir=/usr/lib/x86_64-linux-gnu
elif [[ -d /usr/lib/aarch64-linux-gnu ]]; then
  # Pine A64+ aarch64
  libdir=/usr/lib/aarch64-linux-gnu
fi

# Force the correct value for some platforms where multiple exist
if [[ $platform == 22 ]]; then
  libdir=/usr/lib/x86_64-linux-gnu
fi
# PINE64 boards
if [[ -d /usr/lib/aarch64-linux-gnu ]] && (( $platform >= 40 )) && (( $platform <= 50 )); then
  libdir=/usr/lib/aarch64-linux-gnu
fi

./configure --with-nagios4 --with-boost-libdir=$libdir

#cd livestatus
make
make install
cd ..

# Create log for livestatus
touch /var/log/nagios/livestatus.log
chown nagios:nagios /var/log/nagios/livestatus.log

sleep 5

/bin/systemctl start nagios

printf "Waiting for socket to open..."
while [ ! -S /usr/local/nagios/var/rw/live.sock ]
do
  sleep 2
  printf "."
done
echo " done."

# Allow nagvis to read the socket
chmod 666 /usr/local/nagios/var/rw/live.sock

# /usr/local/nagios/var/rw

# Clean up
rm -rf $tmpdir
