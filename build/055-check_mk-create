#!/bin/bash
# This script is just a reminder for Robbie how to create the tar.gz file for livestatus
# The file is hosted on repos server at packages.nemslinux.com
# Since the developer stopped releasing livestatus separately of their OMD project, I'll create my own livestatus tarball for NEMS Linux
# This is NOT to be run as part of the NEMS Linux build process. This is to create the tarball for distribution, which is called by 055-check_mk
# Created August 12, 2022

ver="2.1.0p9" # Version which corresponds with GitHub release file's tag

# Must have Python 3.10 (not 3.9) so if required, do this first
# Upgrade Python to 3.10
wget -qO - https://raw.githubusercontent.com/tvdsluijs/sh-python-installer/main/python.sh | sudo bash -s 3.10.0

# Clone checkmk
cd /tmp
wget -O checkmk.tar.gz https://github.com/tribe29/checkmk/archive/refs/tags/v${ver}.tar.gz
tar -xvzf checkmk.tar.gz
cd checkmk-*

# Build livestatus tar.gz file
make dist

# While you may get an error, you should now see the needed tar.gz files in omd/packages/mk-livestatus
# Let's setup a new tarball for distribution
mkdir checkmk-livestatus
cd checkmk-livestatus
tar xzf ../omd/packages/mk-livestatus/mk-livestatus-${ver}.tar.gz
rm -rf ../omd/packages/mk-livestatus
cd mk-livestatus-*
dest=$(pwd)
cd ..
rsync -avr ${dest}/* .
rm -rf ${dest}

mkdir omd
cp -R ../omd/packages omd/
cp -R ../buildscripts .

cd ..
if [[ -e /var/www/html/checkmk-livestatus-${ver}.tar.gz ]]; then
  rm -f /var/www/html/checkmk-livestatus-${ver}.tar.gz
fi
tar -zcvf /var/www/html/checkmk-livestatus-${ver}.tar.gz checkmk-livestatus

echo File saved to checkmk-livestatus-${ver}.tar.gz
